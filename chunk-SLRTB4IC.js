import{Bb as M,Db as fe,Eb as v,Ed as $,Fb as ge,Hb as f,Kb as ye,Nb as Se,Ob as me,Pb as Q,Rb as we,Tb as ve,V as h,W as p,da as he,ec as B,ge as Te,n as U,wb as A,wd as x,xd as Ie,yb as j,zb as pe}from"./chunk-4G6DXHXW.js";import{A as V,Aa as oe,C as k,Cb as ue,Da as ce,E as O,F as E,G as C,I as ee,Id as z,Jd as w,M as T,P as te,Pa as le,Wc as de,Yc as q,_ as re,ab as b,c as Y,ea as se,f as K,fa as P,g as W,ia as ae,oa as g,p as X,pa as ie,q as I,r as H,ra as ne,ta as l,u as Z,v as m,z as J}from"./chunk-XYAQ7C66.js";import{a as S,b as R,k as n}from"./chunk-LKDXID24.js";var L="Service workers are disabled or not supported by this browser";function Pe(o){return V(()=>H(new Error(o)))}var F=class{constructor(a){if(this.serviceWorker=a,!a)this.worker=this.events=this.registration=Pe(L);else{let e=k(a,"controllerchange").pipe(m(()=>a.controller)),t=V(()=>I(a.controller)),r=J(t,e);this.worker=r.pipe(C(y=>!!y)),this.registration=this.worker.pipe(P(()=>a.getRegistration()));let u=k(a,"message").pipe(m(y=>y.data)).pipe(C(y=>y&&y.type)).pipe(re());u.connect(),this.events=u}}postMessage(a,d){return this.worker.pipe(T(1),ae(e=>{e.postMessage(S({action:a},d))})).toPromise().then(()=>{})}postMessageWithOperation(a,d,e){let t=this.waitForOperationCompleted(e),r=this.postMessage(a,d);return Promise.all([r,t]).then(([,s])=>s)}generateNonce(){return Math.round(Math.random()*1e7)}eventsOfType(a){let d;return typeof a=="string"?d=e=>e.type===a:d=e=>a.includes(e.type),this.events.pipe(C(d))}nextEventOfType(a){return this.eventsOfType(a).pipe(T(1))}waitForOperationCompleted(a){return this.eventsOfType("OPERATION_COMPLETED").pipe(C(d=>d.nonce===a),T(1),m(d=>{if(d.result!==void 0)return d.result;throw new Error(d.error)})).toPromise()}get isEnabled(){return!!this.serviceWorker}},Ce=(()=>{let a=class a{get isEnabled(){return this.sw.isEnabled}constructor(e){if(this.sw=e,this.pushManager=null,this.subscriptionChanges=new K,!e.isEnabled){this.messages=E,this.notificationClicks=E,this.subscription=E;return}this.messages=this.sw.eventsOfType("PUSH").pipe(m(r=>r.data)),this.notificationClicks=this.sw.eventsOfType("NOTIFICATION_CLICK").pipe(m(r=>r.data)),this.pushManager=this.sw.registration.pipe(m(r=>r.pushManager));let t=this.pushManager.pipe(P(r=>r.getSubscription()));this.subscription=O(t,this.subscriptionChanges)}requestSubscription(e){if(!this.sw.isEnabled||this.pushManager===null)return Promise.reject(new Error(L));let t={userVisibleOnly:!0},r=this.decodeBase64(e.serverPublicKey.replace(/_/g,"/").replace(/-/g,"+")),s=new Uint8Array(new ArrayBuffer(r.length));for(let i=0;i<r.length;i++)s[i]=r.charCodeAt(i);return t.applicationServerKey=s,this.pushManager.pipe(P(i=>i.subscribe(t)),T(1)).toPromise().then(i=>(this.subscriptionChanges.next(i),i))}unsubscribe(){if(!this.sw.isEnabled)return Promise.reject(new Error(L));let e=t=>{if(t===null)throw new Error("Not subscribed to push notifications.");return t.unsubscribe().then(r=>{if(!r)throw new Error("Unsubscribe failed!");this.subscriptionChanges.next(null)})};return this.subscription.pipe(T(1),P(e)).toPromise()}decodeBase64(e){return atob(e)}};a.\u0275fac=function(t){return new(t||a)(l(F))},a.\u0275prov=g({token:a,factory:a.\u0275fac});let o=a;return o})(),_=(()=>{let a=class a{get isEnabled(){return this.sw.isEnabled}constructor(e){if(this.sw=e,!e.isEnabled){this.versionUpdates=E,this.unrecoverable=E;return}this.versionUpdates=this.sw.eventsOfType(["VERSION_DETECTED","VERSION_INSTALLATION_FAILED","VERSION_READY","NO_NEW_VERSION_DETECTED"]),this.unrecoverable=this.sw.eventsOfType("UNRECOVERABLE_STATE")}checkForUpdate(){if(!this.sw.isEnabled)return Promise.reject(new Error(L));let e=this.sw.generateNonce();return this.sw.postMessageWithOperation("CHECK_FOR_UPDATES",{nonce:e},e)}activateUpdate(){if(!this.sw.isEnabled)return Promise.reject(new Error(L));let e=this.sw.generateNonce();return this.sw.postMessageWithOperation("ACTIVATE_UPDATE",{nonce:e},e)}};a.\u0275fac=function(t){return new(t||a)(l(F))},a.\u0275prov=g({token:a,factory:a.\u0275fac});let o=a;return o})();var be=new ne("");function De(o,a,d,e){return()=>{if(!(z(e)&&"serviceWorker"in navigator&&d.enabled!==!1))return;let t=o.get(ue),r=o.get(q);t.runOutsideAngular(()=>{let i=navigator.serviceWorker,c=()=>{var u;return(u=i.controller)==null?void 0:u.postMessage({action:"INITIALIZE"})};i.addEventListener("controllerchange",c),r.onDestroy(()=>{i.removeEventListener("controllerchange",c)})});let s;if(typeof d.registrationStrategy=="function")s=d.registrationStrategy();else{let[i,...c]=(d.registrationStrategy||"registerWhenStable:30000").split(":");switch(i){case"registerImmediately":s=I(null);break;case"registerWithDelay":s=ke(+c[0]||0);break;case"registerWhenStable":s=c[0]?O(Ee(o),ke(+c[0])):Ee(o);break;default:throw new Error(`Unknown ServiceWorker registration strategy: ${d.registrationStrategy}`)}}t.runOutsideAngular(()=>s.pipe(T(1)).subscribe(()=>navigator.serviceWorker.register(a,{scope:d.scope}).catch(i=>console.error("Service worker registration failed with:",i))))}}function ke(o){return I(null).pipe(te(o))}function Ee(o){return o.get(q).isStable.pipe(C(d=>d))}function Le(o,a){return new F(z(a)&&o.enabled!==!1?navigator.serviceWorker:void 0)}var D=class{};function Ne(o,a={}){return ce([Ce,_,{provide:be,useValue:o},{provide:D,useValue:a},{provide:F,useFactory:Le,deps:[D,b]},{provide:de,useFactory:De,deps:[le,be,D,b],multi:!0}])}var Ye=(()=>{let a=class a{static register(e,t={}){return{ngModule:a,providers:[Ne(e,t)]}}};a.\u0275fac=function(t){return new(t||a)},a.\u0275mod=oe({type:a}),a.\u0275inj=ie({providers:[Ce,_]});let o=a;return o})();var He=h("[Transactions] Load Transactions",p()),Ze=h("[Transactions] Load Transactions Success",p()),Je=h("[Transactions] Load Transactions Failure",p()),et=h("[Transactions] Create Transaction",p()),tt=h("[Transactions] Create Transaction Success",p()),rt=h("[Transactions] Create Transaction Failure",p()),st=h("[Transactions] Update Transaction",p()),Ae=h("[Transactions] Update Transaction Success",p()),at=h("[Transactions] Update Transaction Failure",p()),it=h("[Transactions] Delete Transaction",p()),nt=h("[Transactions] Delete Transaction Success",p()),ot=h("[Transactions] Delete Transaction Failure",p()),ct=h("[Transactions] Get Transaction",p()),lt=h("[Transactions] Get Transaction Success",p()),ut=h("[Transactions] Get Transaction Failure",p()),dt=h("[Transactions] Clear Transactions");var Re=(()=>{let a=class a{constructor(e,t,r,s,i,c){this.firestore=e,this.auth=t,this.validationService=r,this.swUpdate=s,this.store=i,this.platformId=c,this.DEFAULT_EXPIRY=24*60*60*1e3,this.DEFAULT_MAX_SIZE=50*1024*1024,this.HIGH_PRIORITY_EXPIRY=7*24*60*60*1e3,this.LOW_PRIORITY_EXPIRY=60*60*1e3,this.networkStatusSubject=new W({online:!1}),this.syncStatusSubject=new W({isOnline:navigator.onLine,pendingItems:0,lastSyncTime:null,isSyncing:!1,failedItems:0,invalidItems:0}),this.networkStatus$=this.networkStatusSubject.asObservable(),this.isOnline$=this.networkStatus$.pipe(m(u=>u.online)),this.serviceWorkerRegistration=null,this.syncQueue=[],w(this.platformId)||(this.networkStatusSubject.next({online:navigator.onLine}),this.initializeServices(),this.setupServiceWorkerSyncListener())}initializeServices(){return n(this,null,function*(){yield Promise.all([this.initializeNetworkMonitoring(),this.initializeServiceWorkerUpdates(),this.initializeBackgroundSync(),this.loadSyncQueue()])})}initializeNetworkMonitoring(){if(w(this.platformId))return;let e=k(window,"online").pipe(m(()=>!0)),t=k(window,"offline").pipe(m(()=>!1));if(O(e,t).pipe(se(navigator.onLine)).subscribe(r=>{this.updateNetworkStatus({online:r}),this.handleNetworkChange(r)}),"connection"in navigator){let r=navigator.connection;r&&r.addEventListener("change",()=>{this.updateNetworkStatus({online:navigator.onLine,connectionType:r.effectiveType,effectiveType:r.effectiveType,downlink:r.downlink,rtt:r.rtt})})}}initializeServiceWorkerUpdates(){if(this.swUpdate.isEnabled){let e=this.isMobileDevice()?B.PWA.MOBILE_UPDATE_INTERVAL:B.PWA.DESKTOP_UPDATE_INTERVAL;setInterval(()=>{this.swUpdate.checkForUpdate()},e),this.swUpdate.versionUpdates.subscribe(t=>{console.log("Service worker update event:",t),t.type==="VERSION_READY"?(console.log("New version available, activating silently:",t),this.activateUpdateSilently()):t.type==="VERSION_INSTALLATION_FAILED"&&(console.error("Service worker installation failed:",t),this.handleUpdateFailure())})}}initializeBackgroundSync(){return n(this,null,function*(){try{if(!("serviceWorker"in navigator)||!("sync"in window)){console.warn("Background Sync API not supported");return}let e=yield navigator.serviceWorker.getRegistrations();if(this.serviceWorkerRegistration=e.find(t=>t.scope.includes("/")||t.scope.includes("/wallet/"))||null,!this.serviceWorkerRegistration){console.warn("Service worker not registered for background sync");return}console.log("Background sync initialized successfully"),this.updateSyncStatus({isOnline:navigator.onLine})}catch(e){console.error("Failed to initialize background sync:",e)}})}handleNetworkChange(e){e?(this.showOnlineNotification(),this.processSyncQueue()):this.showOfflineNotification()}showOnlineNotification(){console.log("You are back online!","Your data will sync automatically.")}showOfflineNotification(){console.log("You are offline","Changes will be saved locally and synced when you reconnect.")}activateUpdateSilently(){this.swUpdate.activateUpdate().then(()=>{console.log("Update activated successfully"),window.location.reload()}).catch(e=>{console.error("Failed to activate update:",e)})}handleUpdateFailure(){console.error("Service worker update failed")}isMobileDevice(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}get syncStatus$(){return this.syncStatusSubject.asObservable()}get syncStatus(){return this.syncStatusSubject.value}registerSyncItem(e){return n(this,null,function*(){try{let t=this.validateSyncItem(e);if(!t.isValid)return console.error("Invalid sync item data:",e.id,t.errors),this.updateSyncStatus({invalidItems:this.syncStatus.invalidItems+1}),{success:!1,errors:t.errors};let r=R(S({},e),{timestamp:Date.now(),retryCount:0,maxRetries:e.maxRetries||3});return this.syncQueue.push(r),yield this.saveSyncQueue(),this.updateSyncStatus({pendingItems:this.syncStatus.pendingItems+1}),navigator.onLine&&(yield this.processSyncQueue()),console.log("Sync item registered:",r.id),{success:!0}}catch(t){return console.error("Failed to register sync item:",t),{success:!1,errors:[t instanceof Error?t.message:"Failed to register sync item"]}}})}processSyncQueue(){return n(this,null,function*(){if(this.syncQueue.length===0)return;this.updateSyncStatus({isSyncing:!0});let e=ve(this.firestore),t=[],r=[];for(let s of this.syncQueue)try{let i=this.getCurrentUserId();if(!i)continue;switch(s.type){case"transaction":yield this.processTransactionSync(s,e,i);break;case"budget":yield this.processBudgetSync(s,e,i);break;case"account":yield this.processAccountSync(s,e,i);break;case"goal":yield this.processGoalSync(s,e,i);break}t.push(s.id),s.type==="transaction"&&(yield this.updateTransactionSyncStatus(s.data.id||s.id,"synced"))}catch(i){console.error(`Failed to process sync item ${s.id}:`,i),s.retryCount++,s.retryCount>=(s.maxRetries||3)&&(r.push(s.id),s.type==="transaction"&&(yield this.updateTransactionSyncStatus(s.data.id||s.id,"failed")))}if(t.length>0)try{yield e.commit(),this.syncQueue=this.syncQueue.filter(s=>!t.includes(s.id)),yield this.saveSyncQueue(),this.updateSyncStatus({lastSyncTime:Date.now(),pendingItems:this.syncQueue.length,failedItems:r.length,isSyncing:!1}),console.log(`\u2705 Processed ${t.length} sync items`)}catch(s){console.error("Failed to commit sync operations:",s),this.updateSyncStatus({isSyncing:!1})}else this.updateSyncStatus({isSyncing:!1})})}processTransactionSync(e,t,r){return n(this,null,function*(){let s=v(this.firestore,`users/${r}/transactions`);switch(e.operation){case"create":let i=f(this.firestore,`users/${r}/transactions/${e.data.id}`);t.set(i,e.data);break;case"update":let c=f(this.firestore,`users/${r}/transactions/${e.data.id}`);t.update(c,e.data);break;case"delete":let u=f(this.firestore,`users/${r}/transactions/${e.data.id}`);t.delete(u);break}})}updateTransactionSyncStatus(e,t){return n(this,null,function*(){try{this.store.dispatch(Ae({transaction:{id:e,syncStatus:t,lastSyncedAt:new Date}})),console.log(`Transaction ${e} sync status updated to: ${t}`)}catch(r){console.error("Failed to update transaction sync status:",r)}})}processBudgetSync(e,t,r){return n(this,null,function*(){let s=v(this.firestore,`users/${r}/budgets`);switch(e.operation){case"create":let i=f(s);t.set(i,e.data);break;case"update":let c=f(this.firestore,`users/${r}/budgets/${e.data.id}`);t.update(c,e.data);break;case"delete":let u=f(this.firestore,`users/${r}/budgets/${e.data.id}`);t.delete(u);break}})}processAccountSync(e,t,r){return n(this,null,function*(){let s=v(this.firestore,`users/${r}/accounts`);switch(e.operation){case"create":let i=f(s);t.set(i,e.data);break;case"update":let c=f(this.firestore,`users/${r}/accounts/${e.data.id}`);t.update(c,e.data);break;case"delete":let u=f(this.firestore,`users/${r}/accounts/${e.data.id}`);t.delete(u);break}})}processGoalSync(e,t,r){return n(this,null,function*(){let s=v(this.firestore,`users/${r}/goals`);switch(e.operation){case"create":let i=f(s);t.set(i,e.data);break;case"update":let c=f(this.firestore,`users/${r}/goals/${e.data.id}`);t.update(c,e.data);break;case"delete":let u=f(this.firestore,`users/${r}/goals/${e.data.id}`);t.delete(u);break}})}validateSyncItem(e){let t=[];if(!e.id||!e.type||!e.data)return t.push("Missing required fields: id, type, or data"),{isValid:!1,errors:t};switch(e.type){case"transaction":let r=this.validationService.validateTransactionData(e.data);r.isValid||t.push(...r.errors);break;case"budget":let s=this.validationService.validateCommonData(e.data);s.isValid||t.push(...s.errors);break;case"account":let i=this.validationService.validateCommonData(e.data);i.isValid||t.push(...i.errors);break;case"goal":let c=this.validationService.validateCommonData(e.data);c.isValid||t.push(...c.errors);break}return{isValid:t.length===0,errors:t}}triggerBackgroundSync(e){return n(this,null,function*(){if(!this.serviceWorkerRegistration){console.warn("Service worker not available for background sync");return}try{this.updateSyncStatus({isSyncing:!0});let t=e||"sync-transactions";"sync"in this.serviceWorkerRegistration?(yield this.serviceWorkerRegistration.sync.register(t),console.log("Background sync triggered:",t)):console.warn("Background Sync is not supported in this browser."),this.updateSyncStatus({lastSyncTime:Date.now(),isSyncing:!1})}catch(t){console.error("Failed to trigger background sync:",t),this.updateSyncStatus({isSyncing:!1})}})}manualSync(){return n(this,null,function*(){console.log("Manual sync triggered"),yield this.processSyncQueue()})}getSyncStats(){return n(this,null,function*(){let e=this.syncQueue.length+this.syncStatus.failedItems+this.syncStatus.invalidItems,t=e>0?this.syncQueue.length/e*100:0;return{totalPending:this.syncQueue.length,totalFailed:this.syncStatus.failedItems,totalInvalid:this.syncStatus.invalidItems,lastSyncTime:this.syncStatus.lastSyncTime,syncSuccessRate:t}})}clearCompletedItems(){return n(this,null,function*(){try{this.updateSyncStatus({pendingItems:this.syncQueue.length,failedItems:0,invalidItems:0})}catch(e){console.error("Failed to clear completed items:",e)}})}cacheData(s,i){return n(this,arguments,function*(e,t,r={}){if(!w(this.platformId))try{let c={key:e,data:t,timestamp:Date.now(),expiry:r.expiry||this.getDefaultExpiry(r.priority),size:this.calculateSize(t),priority:r.priority||"normal"};yield this.storeInCacheStorage(e,c),yield this.storeInLocalStorage(e,c),yield this.cleanupCache()}catch(c){console.error("Failed to cache data:",c)}})}getCachedData(e){return n(this,null,function*(){if(w(this.platformId))return null;try{let t=yield this.getFromCacheStorage(e);return t||(t=yield this.getFromLocalStorage(e)),t?this.isExpired(t)?(yield this.removeCachedData(e),null):t.data:null}catch(t){return console.error("Failed to get cached data:",t),null}})}removeCachedData(e){return n(this,null,function*(){if(!w(this.platformId))try{yield Promise.all([this.removeFromCacheStorage(e),this.removeFromLocalStorage(e)])}catch(t){console.error("Failed to remove cached data:",t)}})}clearCache(){return n(this,null,function*(){if(!w(this.platformId))try{yield Promise.all([this.clearCacheStorage(),this.clearLocalStorage()])}catch(e){console.error("Failed to clear cache:",e)}})}getCacheStats(){return n(this,null,function*(){if(w(this.platformId))return{totalItems:0,totalSize:0,expiredItems:0,cacheStorageSize:0,localStorageSize:0};try{let[e,t]=yield Promise.all([this.getAllFromCacheStorage(),this.getAllFromLocalStorage()]),r=[...e,...t],s=this.deduplicateItems(r),i=s.filter(u=>this.isExpired(u)),c=s.reduce((u,y)=>u+y.size,0);return{totalItems:s.length,totalSize:c,expiredItems:i.length,cacheStorageSize:e.length,localStorageSize:t.length}}catch(e){return console.error("Failed to get cache stats:",e),{totalItems:0,totalSize:0,expiredItems:0,cacheStorageSize:0,localStorageSize:0}}})}getCurrentNetworkStatus(){return this.networkStatusSubject.value}isCurrentlyOnline(){return this.networkStatusSubject.value.online}shouldWorkOffline(){try{let t=j().currentUser;return!t||!localStorage.getItem(`user-data-${t.uid}`)?!1:!!(localStorage.getItem("app-cache-version")||localStorage.getItem("transactions-cache")||localStorage.getItem("categories-cache"))}catch(e){return console.error("Error checking offline capability:",e),!1}}getConnectionQuality(){let e=this.networkStatusSubject.value;return e.online?e.effectiveType==="4g"?"excellent":e.effectiveType==="3g"?"good":e.effectiveType==="2g"?"poor":"unknown":"offline"}requestNotificationPermission(){return"Notification"in window?Notification.requestPermission():Promise.resolve("denied")}updateNetworkStatus(e){let t=this.networkStatusSubject.value,r=S(S({},t),e);this.networkStatusSubject.next(r)}updateSyncStatus(e){let t=this.syncStatusSubject.value,r=S(S({},t),e);this.syncStatusSubject.next(r)}getCurrentUserId(){var e;return((e=this.auth.currentUser)==null?void 0:e.uid)||null}loadSyncQueue(){return n(this,null,function*(){try{let e=yield this.getCachedData("sync-queue");e&&Array.isArray(e)?(this.syncQueue=e,this.updateSyncStatus({pendingItems:this.syncQueue.length})):(this.syncQueue=[],this.updateSyncStatus({pendingItems:0}))}catch(e){console.error("Failed to load sync queue:",e),this.syncQueue=[],this.updateSyncStatus({pendingItems:0})}})}saveSyncQueue(){return n(this,null,function*(){try{yield this.cacheData("sync-queue",this.syncQueue)}catch(e){console.error("Failed to save sync queue:",e)}})}getDefaultExpiry(e){switch(e){case"high":return this.HIGH_PRIORITY_EXPIRY;case"low":return this.LOW_PRIORITY_EXPIRY;default:return this.DEFAULT_EXPIRY}}calculateSize(e){try{let t=JSON.stringify(e);return new Blob([t]).size}catch{return 0}}isExpired(e){return e.expiry?Date.now()>e.timestamp+e.expiry:!1}cleanupCache(){return n(this,null,function*(){try{let e=yield this.getCacheStats(),t=yield this.getCacheKeys();for(let r of t)(yield this.getCachedData(r))===null&&(yield this.removeCachedData(r));if(e.totalSize>this.DEFAULT_MAX_SIZE){let s=(yield this.getAllFromCacheStorage()).filter(i=>!this.isExpired(i)).sort((i,c)=>{let u={high:3,normal:2,low:1},y=u[i.priority],G=u[c.priority];return y!==G?G-y:i.timestamp-c.timestamp});for(let i of s)if(i.priority==="low"&&(yield this.removeCachedData(i.key),(yield this.getCacheStats()).totalSize<=this.DEFAULT_MAX_SIZE*.8))break}}catch(e){console.error("Failed to cleanup cache:",e)}})}getCacheKeys(){return n(this,null,function*(){if(w(this.platformId))return[];try{let[e,t]=yield Promise.all([this.getCacheStorageKeys(),this.getLocalStorageKeys()]);return[...new Set([...e,...t])]}catch(e){return console.error("Failed to get cache keys:",e),[]}})}storeInCacheStorage(e,t){return n(this,null,function*(){if("caches"in window)try{let r=yield caches.open("money-manager-data"),s=new Response(JSON.stringify(t));yield r.put(e,s)}catch(r){console.warn("Failed to store in Cache Storage:",r)}})}storeInLocalStorage(e,t){return n(this,null,function*(){try{localStorage.setItem(e,JSON.stringify(t))}catch(r){console.warn("Failed to store in Local Storage:",r)}})}getFromCacheStorage(e){return n(this,null,function*(){if("caches"in window)try{let r=yield(yield caches.open("money-manager-data")).match(e);if(r)return yield r.json()}catch(t){console.warn("Failed to get from Cache Storage:",t)}return null})}getFromLocalStorage(e){return n(this,null,function*(){try{let t=localStorage.getItem(e);if(t)return JSON.parse(t)}catch(t){console.warn("Failed to get from Local Storage:",t)}return null})}removeFromCacheStorage(e){return n(this,null,function*(){if("caches"in window)try{yield(yield caches.open("money-manager-data")).delete(e)}catch(t){console.warn("Failed to remove from Cache Storage:",t)}})}removeFromLocalStorage(e){return n(this,null,function*(){try{localStorage.removeItem(e)}catch(t){console.warn("Failed to remove from Local Storage:",t)}})}clearCacheStorage(){return n(this,null,function*(){if("caches"in window)try{let e=yield caches.keys();yield Promise.all(e.map(t=>caches.delete(t)))}catch(e){console.warn("Failed to clear Cache Storage:",e)}})}clearLocalStorage(){return n(this,null,function*(){try{localStorage.clear()}catch(e){console.warn("Failed to clear Local Storage:",e)}})}getAllFromCacheStorage(){return n(this,null,function*(){if("caches"in window)try{let e=yield caches.open("money-manager-data"),t=yield e.keys(),r=[];for(let s of t){let i=yield e.match(s);if(i){let c=yield i.json();r.push(c)}}return r}catch(e){console.warn("Failed to get all from Cache Storage:",e)}return[]})}getAllFromLocalStorage(){return n(this,null,function*(){try{let e=[];for(let t=0;t<localStorage.length;t++){let r=localStorage.key(t);if(r){let s=localStorage.getItem(r);if(s)try{let i=JSON.parse(s);e.push(i)}catch{}}}return e}catch(e){return console.warn("Failed to get all from Local Storage:",e),[]}})}getCacheStorageKeys(){return n(this,null,function*(){if("caches"in window)try{return(yield(yield caches.open("money-manager-data")).keys()).map(r=>r.url)}catch(e){console.warn("Failed to get Cache Storage keys:",e)}return[]})}getLocalStorageKeys(){return n(this,null,function*(){try{let e=[];for(let t=0;t<localStorage.length;t++){let r=localStorage.key(t);r&&e.push(r)}return e}catch(e){return console.warn("Failed to get Local Storage keys:",e),[]}})}deduplicateItems(e){let t=new Map;for(let r of e){let s=t.get(r.key);(!s||r.timestamp>s.timestamp)&&t.set(r.key,r)}return Array.from(t.values())}isSupported(){return"serviceWorker"in navigator&&"sync"in window}setupServiceWorkerSyncListener(){"serviceWorker"in navigator&&navigator.serviceWorker.addEventListener("message",e=>{if(e.data&&e.data.type==="SYNC_COMPLETED"){let{transactionId:t,success:r}=e.data;t&&this.updateTransactionSyncStatus(t,r?"synced":"failed")}})}};a.\u0275fac=function(t){return new(t||a)(l(M),l(A),l(Ie),l(_),l(he),l(b))},a.\u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"});let o=a;return o})();var Ft=(()=>{let a=class a{constructor(e){this.platformId=e}isClientSide(){return!w(this.platformId)}};a.\u0275fac=function(t){return new(t||a)(l(b))},a.\u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"});let o=a;return o})();var Oe={SESSION_TIMEOUT:30*60*1e3,INACTIVITY_TIMEOUT:60*60*1e3,MAX_LOGIN_ATTEMPTS:5,LOCKOUT_DURATION:15*60*1e3,PASSWORD_MIN_LENGTH:8,REQUIRE_EMAIL_VERIFICATION:!0,ENABLE_RATE_LIMITING:!0,SECURE_HEADERS:!0},Nt=(()=>{let a=class a{constructor(e,t,r,s,i){this.router=e,this.userService=t,this.notificationService=r,this.loaderService=s,this.commonSyncService=i,this.sessionStartTime=new Map,this.startSessionMonitoring()}canActivate(e,t){return this.performSecurityCheck(e,t)}canActivateChild(e,t){return this.performSecurityCheck(e,t)}performSecurityCheck(e,t){this.loaderService.show();let r=j(),s=r.currentUser;return s?(this.backgroundSecurityCheck(e,t,s),I(!0)):new Y(i=>{let c=pe(r,u=>{c(),u?(this.backgroundSecurityCheck(e,t,u),i.next(!0),this.loaderService.hide()):this.handleUnauthenticatedUser(t).then(()=>{this.loaderService.hide(),i.next(!1)})})}).pipe(Z(1e4),ee(i=>(console.error("[AuthGuard] Timeout or error:",i),this.router.navigate(["/sign-in"],{queryParams:{error:"auth_timeout",redirect:t.url}}),I(!1))))}backgroundSecurityCheck(e,t,r){setTimeout(()=>n(this,null,function*(){try{if(this.sessionStartTime.has(r.uid)||this.updateSessionTimestamp(r.uid),this.isSessionExpired(r.uid)){yield this.handleSessionExpired(r,t);return}let s=!this.commonSyncService.isCurrentlyOnline(),i;if(s?(i=this.userService.getCachedUserData(r.uid),console.log("[AuthGuard] Offline mode - using cached user data:",i?"found":"not found")):i=yield this.userService.getCurrentUser(),!i)if(s){console.warn("[AuthGuard] Offline mode - no cached user data available, allowing access"),this.updateSessionTimestamp(r.uid);return}else{yield this.handleInvalidUserData(r,t);return}if(!(yield this.checkRoutePermissions(e,i,r))){yield this.handleInsufficientPermissions(i,t);return}this.updateSessionTimestamp(r.uid)}catch(s){if(console.error("[AuthGuard] Background error:",s),!this.commonSyncService.isCurrentlyOnline()){console.warn("[AuthGuard] Offline mode - error occurred, allowing access for offline use"),this.updateSessionTimestamp(r.uid);return}yield this.handleSecurityError(s,t)}finally{this.loaderService.hide()}}),0)}checkRoutePermissions(e,t,r){return n(this,null,function*(){var i;let s=e.data;return s!=null&&s.requireEmailVerification&&!r.emailVerified?(console.warn("[AuthGuard] Email not verified"),!1):((i=s==null?void 0:s.roles)==null?void 0:i.length)>0&&!s.roles.includes(t.role)?(console.warn("[AuthGuard] Insufficient role:",t.role),!1):s!=null&&s.requireTwoFactor&&!this.hasTwoFactorEnabled(t)?(console.warn("[AuthGuard] Two-factor required"),!1):!0})}isSessionExpired(e){let t=this.sessionStartTime.get(e),r=Date.now();return!!t&&r-t>Oe.SESSION_TIMEOUT}updateSessionTimestamp(e){this.sessionStartTime.set(e,Date.now())}handleUnauthenticatedUser(e){return n(this,null,function*(){this.router.navigate(["/sign-in"],{queryParams:{session:"expired",redirect:e.url}})})}handleSessionExpired(e,t){return n(this,null,function*(){this.sessionStartTime.delete(e.uid),this.userService.clearCachedUserData(),yield this.userService.signOut(),this.router.navigate(["/sign-in"],{queryParams:{session:"expired",redirect:t.url,reason:"timeout"}})})}handleInvalidUserData(e,t){return n(this,null,function*(){this.userService.clearCachedUserData(),yield this.userService.signOut(),this.router.navigate(["/sign-in"],{queryParams:{error:"invalid_user_data",redirect:t.url}})})}handleInsufficientPermissions(e,t){return n(this,null,function*(){this.notificationService.error("Access Denied: You do not have permission to access this page."),this.router.navigate(["/dashboard"],{queryParams:{error:"insufficient_permissions",requestedRoute:t.url}})})}handleSecurityError(e,t){return n(this,null,function*(){this.router.navigate(["/sign-in"],{queryParams:{error:"security_error",redirect:t.url,message:e.message||"Unknown error"}})})}startSessionMonitoring(){let e,t=()=>{clearTimeout(e),e=setTimeout(()=>{this.handleInactivity()},Oe.INACTIVITY_TIMEOUT)};["mousedown","mousemove","keypress","scroll","touchstart"].forEach(r=>{document.addEventListener(r,t,!0)}),t()}handleInactivity(){let e=this.userService.userAuth$.value;e&&(console.log("[AuthGuard] Inactivity detected. Logging out user:",e.uid),this.userService.signOut())}hasTwoFactorEnabled(e){return!1}};a.\u0275fac=function(t){return new(t||a)(l(U),l($),l(x),l(Te),l(Re))},a.\u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"});let o=a;return o})();var xt=(()=>{let a=class a{constructor(e,t,r,s){this.auth=e,this.router=t,this.notificationService=r,this.userService=s}canActivate(e,t){return X(this.checkAdminAccess())}checkAdminAccess(){return n(this,null,function*(){try{return(yield this.auth.currentUser)?(yield this.isUserAdmin())?!0:(this.notificationService.error("Admin access required"),this.router.navigate(["/dashboard"]),!1):(this.notificationService.error("Authentication required"),this.router.navigate(["/sign-in"]),!1)}catch(e){return console.error("Error checking admin access:",e),this.notificationService.error("Failed to verify admin access"),this.router.navigate(["/dashboard"]),!1}})}isUserAdmin(){return n(this,null,function*(){return this.userService.isAdmin})}};a.\u0275fac=function(t){return new(t||a)(l(A),l(U),l(x),l($))},a.\u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"});let o=a;return o})();var Vt=(()=>{let a=class a{constructor(e,t){this.firestore=e,this.auth=t}submitFeedback(e){return n(this,null,function*(){var t;try{let r=R(S({},e),{userId:((t=this.auth.currentUser)==null?void 0:t.uid)||"anonymous",timestamp:Q(),status:"pending",userAgent:navigator.userAgent,appVersion:"1.0.0"}),s=v(this.firestore,"feedback"),i=yield fe(s,r);console.log("Feedback submitted successfully:",i.id)}catch(r){throw console.error("Error submitting feedback:",r),r}})}getCategoryLabel(e){return{bug:"Bug Report",feature:"Feature Request",improvement:"Improvement Suggestion",general:"General Feedback",support:"Support Request"}[e]||e}getAllFeedback(){return n(this,null,function*(){try{let e=v(this.firestore,"feedback"),t=me(e,Se("timestamp","desc")),r=yield ye(t),s=[];return r.forEach(i=>{let c=i.data();s.push(R(S({},c),{id:i.id}))}),s}catch(e){throw console.error("Error fetching feedback:",e),e}})}updateFeedbackStatus(e,t){return n(this,null,function*(){try{let r=f(this.firestore,"feedback",e);yield we(r,{status:t,updatedAt:Q()})}catch(r){throw console.error("Error updating feedback status:",r),r}})}deleteFeedback(e){return n(this,null,function*(){try{let t=f(this.firestore,"feedback",e);yield ge(t)}catch(t){throw console.error("Error deleting feedback:",t),t}})}};a.\u0275fac=function(t){return new(t||a)(l(M),l(A))},a.\u0275prov=g({token:a,factory:a.\u0275fac,providedIn:"root"});let o=a;return o})();export{He as a,Ze as b,Je as c,et as d,tt as e,rt as f,st as g,Ae as h,at as i,it as j,nt as k,ot as l,ct as m,lt as n,ut as o,dt as p,_ as q,Ye as r,Re as s,Ft as t,Nt as u,xt as v,Vt as w};
